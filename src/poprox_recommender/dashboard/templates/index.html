{% extends "base.html" %}
{% block content %}
<section class="filters">
  <form method="get" class="filter-form">
    <label>
      User ID
      <input type="text" name="request_id" value="{{ selected_request_id }}" placeholder="Exact or prefix" />
    </label>
    <label>
      Date
      <input type="date" name="date" id="date-filter" value="{{ selected_date }}" />
    </label>
    <label>
      Limit
      <input type="number" name="limit" min="1" max="500" value="{{ limit }}" />
    </label>
    <button type="submit">Apply</button>
    <a class="reset-link" href="/">Reset</a>
  </form>
  <div class="logs-actions">
    <button id="fetch-logs-btn" onclick="fetchLambdaLogs()" {% if not selected_date %}disabled{% endif %}>
      Fetch Lambda Errors
    </button>
    <span id="logs-status"></span>
  </div>
</section>

<section id="lambda-logs" style="display: none;">
  <h2>Lambda Execution Errors</h2>
  <div id="logs-content"></div>
</section>

<section class="session-table">
  {% if sessions %}
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>User ID</th>
        <th>Session</th>
        <th>Pipeline</th>
        <th>Articles</th>
        <th>Duration</th>
        <th>Timeout Risk</th>
        <th>Ranker</th>
        <th>Rewriter</th>
        <th>Issues</th>
      </tr>
    </thead>
    <tbody>
      {% for session in sessions %}
      {% set ranker = session.component_summary.get('ranker', {}) %}
      {% set rewriter = session.component_summary.get('rewriter', {}) %}
      {% set timeout_info = session.timeout_info or {} %}
      {% set elapsed = timeout_info.get('elapsed_seconds') %}
      {% set is_at_risk = timeout_info.get('is_at_risk', false) %}
      {% set timeout_pct = timeout_info.get('timeout_risk_percentage', 0) %}
      <tr>
        <td>{{ session.timestamp.strftime("%Y-%m-%d %H:%M:%S") }}</td>
        <td>{{ session.request_id }}</td>
        <td><a href="/sessions/{{ session.session_id }}">{{ session.session_id }}</a></td>
        <td>{{ session.pipeline if session.pipeline else 'n/a' }}</td>
        <td>{{ session.num_articles }}</td>
        <td>{% if elapsed %}{{ '%.2f'|format(elapsed) }}s{% else %}-{% endif %}</td>
        <td>
          {% if is_at_risk %}
            <span class="timeout-risk">⚠️ {{ '%.0f'|format(timeout_pct) }}%</span>
          {% elif elapsed %}
            {{ '%.0f'|format(timeout_pct) }}%
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ ranker.get('status', 'n/a') }} {% if ranker.get('duration_seconds') %}<small>({{ '%.2f'|format(ranker['duration_seconds']) }}s)</small>{% endif %}</td>
        <td>{{ rewriter.get('status', 'n/a') }} {% if rewriter.get('duration_seconds') %}<small>({{ '%.2f'|format(rewriter['duration_seconds']) }}s)</small>{% endif %}</td>
        <td>{% if session.issue_count %}<span class="issue-count">{{ session.issue_count }}</span>{% else %}0{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No sessions found for the selected filters.</p>
  {% endif %}
</section>

<script>
async function fetchLambdaLogs() {
  const dateInput = document.getElementById('date-filter');
  const selectedDate = dateInput.value;

  if (!selectedDate) {
    alert('Please select a date first');
    return;
  }

  const logsSection = document.getElementById('lambda-logs');
  const logsContent = document.getElementById('logs-content');
  const statusSpan = document.getElementById('logs-status');
  const fetchBtn = document.getElementById('fetch-logs-btn');

  // Show loading state
  statusSpan.textContent = 'Fetching logs...';
  fetchBtn.disabled = true;
  logsContent.innerHTML = '<p>Loading...</p>';
  logsSection.style.display = 'block';

  try {
    const response = await fetch(`/api/logs/errors?date=${selectedDate}`);
    const data = await response.json();

    if (data.success) {
      statusSpan.textContent = `Found ${data.count} error(s)`;

      if (data.count === 0) {
        logsContent.innerHTML = '<p>No errors found for this date.</p>';
      } else {
        let html = '<div class="logs-list">';
        data.events.forEach(event => {
          const timestamp = new Date(event.timestamp).toLocaleString();
          const requestId = event.request_id || 'N/A';
          html += `
            <div class="log-event">
              <div class="log-header">
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-request-id">Request: ${requestId}</span>
                <span class="log-stream">${event.log_stream}</span>
              </div>
              <pre class="log-message">${escapeHtml(event.message)}</pre>
            </div>
          `;
        });
        html += '</div>';
        logsContent.innerHTML = html;
      }
    } else {
      statusSpan.textContent = 'Error fetching logs';
      logsContent.innerHTML = `<p class="error">Error: ${escapeHtml(data.error)}</p>`;
    }
  } catch (error) {
    statusSpan.textContent = 'Failed to fetch logs';
    logsContent.innerHTML = `<p class="error">Failed to fetch logs: ${escapeHtml(error.message)}</p>`;
  } finally {
    fetchBtn.disabled = false;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
{% endblock %}
